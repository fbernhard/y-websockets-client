{"version":3,"file":"y-websockets-client.node.js","sources":["src/y-websockets-client.js"],"sourcesContent":["import io from 'socket.io-client'\n\nexport default function extend (Y) {\n  class Connector extends Y.AbstractConnector {\n    constructor (y, options) {\n      if (options === undefined) {\n        throw new Error('Options must not be undefined!')\n      }\n      options.role = 'slave'\n      options.preferUntransformed = true\n      options.generateUserId = options.generateUserId || false\n      if (options.initSync !== false) { options.initSync = true }\n      super(y, options)\n      this._sentSync = false\n      this.options = options\n      options.url = options.url || 'https://yjs.dbis.rwth-aachen.de:5072'\n      var socket = options.socket || io(options.url, options.options)\n      this.socket = socket\n      var self = this\n\n      this._onConnect = () => {\n        if (options.initSync) {\n          if (options.room == null) {\n            throw new Error('You must define a room name!')\n          }\n          this._sentSync = true\n          // only sync with server when connect = true\n          socket.emit('joinRoom', options.room)\n          self.userJoined('server', 'master')\n          self.connections.get('server').syncStep2.promise.then(() => {\n            // set user id when synced with server\n            self.setUserId(Y.utils.generateUserId())\n          })\n        }\n        socket.on('yjsEvent', this._onYjsEvent)\n        socket.on('disconnect', this._onDisconnect)\n      }\n\n      socket.on('connect', this._onConnect)\n      if (socket.connected) {\n        this._onConnect()\n      } else {\n        socket.connect()\n      }\n\n      this._onYjsEvent = function (buffer) {\n        let decoder = new Y.utils.BinaryDecoder(buffer)\n        let roomname = decoder.readVarString()\n        if (roomname === options.room) {\n          self.receiveMessage('server', buffer)\n        }\n      }\n\n      this._onDisconnect = function (peer) {\n        Y.AbstractConnector.prototype.disconnect.call(self)\n      }\n    }\n\n    /*\n     * Call this if you set options.initSync = false. Yjs will sync with the server after calling this method.\n     */\n    initSync (opts) {\n      if (!this.options.initSync) {\n        this.options.initSync = true\n        if (opts.room != null) {\n          this.options.room = opts.room\n        }\n      }\n      if (this.socket.connected) {\n        this._onConnect()\n      }\n    }\n\n    disconnect () {\n      this.socket.emit('leaveRoom', this.options.room)\n      if (!this.options.socket) {\n        this.socket.disconnect()\n      }\n      super.disconnect()\n    }\n    destroy () {\n      this.disconnect()\n      this.socket.off('disconnect', this._onDisconnect)\n      this.socket.off('yjsEvent', this._onYjsEvent)\n      this.socket.off('connect', this._onConnect)\n      if (!this.options.socket) {\n        this.socket.destroy()\n      }\n      this.socket = null\n    }\n    reconnect () {\n      this.socket.connect()\n      super.reconnect()\n    }\n    send (uid, message) {\n      if (this._sentSync) {\n        super.send(uid, message)\n        this.socket.emit('yjsEvent', message)\n      }\n    }\n    broadcast (message) {\n      if (this._sentSync) {\n        super.broadcast(message)\n        this.socket.emit('yjsEvent', message)\n      }\n    }\n    whenRemoteResponsive () {\n      return new Promise(resolve => {\n        this.socket.emit('yjsResponsive', this.options.room, resolve)\n      })\n    }\n    isDisconnected () {\n      return this.socket.disconnected\n    }\n  }\n  Connector.io = io\n  Y['websockets-client'] = Connector\n  // Y.extend('websockets-client', Connector)\n}\n\nif (typeof Y !== 'undefined') {\n  extend(Y) // eslint-disable-line\n}\n"],"names":[],"mappings":"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"}